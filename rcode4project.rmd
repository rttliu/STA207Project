---
title: "Preprocessing/Cleaning"
author: "Ruitian Liu, Zhiye Jiang, Yuyu Zhang, Tommy Yu"
date: "2026-02-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r libraries, message=FALSE, warning=FALSE}
# Data Preparation and Cleaning
### Load necessary libraries, covering data processing, string manipulation, visualization, and diagnostic analysis
library(stringr)
library(dplyr)
library(tidyr)
library(patchwork)
library(purrr)
library(rcompanion)
library(psych)
library(dlookr)
```


```{r load-data}
# Please ensure the file exists at this path
df <- read.table("STAR.tab", header = TRUE, sep = "\t")
```


  
```{r phase-1}
## Phase 1: Column Name Filtering and Cleanin
# Truncate column names to the first 8 characters; STAR dataset column names usually contain grade prefixes (e.g., gk, g1, etc.)
names(df) <- substr(names(df), 1, 8)
cols <- names(df)

# Use regular expressions to extract column names starting with gk, g1, g2, g3
m <- regexpr("^(gk|g1|g2|g3)(.*)$", cols, perl = TRUE)
prefix <- regmatches(cols, m)
suffix <- sub("^(gk|g1|g2|g3)", "", prefix)

# Count the frequency of each variable and filter variables that exist across all grades (appearing at least 4 times)
tab <- table(suffix)
valid_suffix <- names(tab[tab >= 4])

# Construct the list of column names to keep
keep_cols <- unlist(lapply(valid_suffix, function(s) paste0(c("gk","g1","g2","g3"), s)))

# Separate basic student information (assuming the first 6 columns are basic info) and teaching data corresponding to grades
student_info <- df[, 1:6, drop = FALSE]
df_keep <- df[, intersect(names(df), keep_cols), drop = FALSE]
star <- cbind(student_info, df_keep)

```

  
```{r phase-2}
## Phase 2: Data Reshaping (Wide to Long -> Long to Wide)
# Convert the dataset from wide format to long format, then back to wide format, to standardize the grade structure
stars <- star %>%
  pivot_longer(cols = matches("^(gk|g1|g2|g3)"),
               names_to = c("grade", "variable"),
               names_pattern = "^g([k123])(.*)$", # Capture grade (k, 1, 2, 3) and variable names
               values_to = "value") %>%
  pivot_wider(names_from = variable,
              values_from = value) %>%
  # Convert the grade column into an ordered factor
  mutate(grade = dplyr::recode(grade, k = "K"),
         grade = factor(grade, levels = c("K", "1", "2", "3"), ordered = TRUE))

```

  
```{r phase-3}
## Phase 3: Renaming and Variable Type Conversion
# Standardize variable names to make them more readable
stars <- stars %>% rename(
  student_id = stdntid, birth_month = birthmon, birth_day = birthday, 
  birth_year = birthyea, teaching_years = tyears, class_size = classs, 
  math_score = tmaths, school_id = schid, teacher_id = tchid)

# Convert categorical variables into factors for subsequent statistical analysis
stars[c("surban","classt","thighd","tcaree","gender","tgen","freelu","trace","race")] <- 
  lapply(stars[c("surban","classt","thighd","tcaree","gender","tgen","freelu","trace","race")], factor)

# Perform preliminary diagnostic analysis on categorical data
stars %>% dplyr::filter(if_all(where(is.factor), ~ !is.na(.))) %>% diagnose_category()

```

  
```{r phase-4}
## Phase 4: Feature Engineering and Variable Cleaning
# Use case_when to create more descriptive categorical variables and delete unnecessary raw variables
stars1 <- stars %>% mutate(
  # Area type encoding conversion
  area_type = factor(case_when(
    surban == 1 ~ "Inner City",
    surban == 2 ~ "Suburban",
    surban == 3 ~ "Rural",
    surban == 4 ~ "Urban",
    TRUE ~ NA_character_)),
  # Class type encoding conversion
  class_type = factor(classt, levels = c(1, 2, 3),
                      labels = c("Small class", "Regular class", "Regular + aide")),
  # Teacher degree level binning
  teacher_degree = factor(case_when(
    thighd %in% c(1, 2) ~ "Below Master",
    thighd %in% c(3, 4, 5, 6) ~ "Master or above",
    TRUE ~ NA_character_),
    levels = c("Below Master", "Master or above"), ordered = TRUE),
  # Teacher career stage binning
  teacher_career = factor(case_when(
    tcaree %in% c(1, 2, 3) ~ "Lower level",
    tcaree %in% c(4, 5, 6, 7) ~ "Upper level",
    TRUE ~ NA_character_),
    levels = c("Lower level", "Upper level"), ordered = TRUE),
  # Gender and free lunch encoding conversion
  student_gender = factor(gender, levels = c(1, 2),
                          labels = c("Male", "Female")),
  teacher_gender = factor(tgen, levels = c(1, 2),
                          labels = c("Male", "Female")),
  free_lunch = factor(freelu, levels = c(1, 2),
                      labels = c("Free lunch", "Non-free lunch")),
  # Racial binarization
  teacher_race = factor(case_when(
    trace == 2 ~ "Black",
    trace %in% c(1, 3, 4, 5, 6) ~ "Non-Black",
    TRUE ~ NA_character_),
    levels = c("Black", "Non-Black")),
  student_race = factor(case_when(
    race == 2 ~ "Black",
    race %in% c(1, 3, 4, 5, 6) ~ "Non-Black",
    TRUE ~ NA_character_),
    levels = c("Black", "Non-Black"))
) %>%
  # Delete the converted raw variables and analysis indicators that are no longer needed; here, we only keep the math scores for performance variables
  select(-surban, -classt, -thighd, -gender, -race, -tcaree, -tgen, -freelu, -trace,
         -tlists, -wordsk, -readbs, -motivr, -selfco, -treads, -mathbs, -starts_with("gk"))

```
